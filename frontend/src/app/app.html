<div class="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20 notranslate" translate="no">
  
  <header class="bg-indigo-900 text-white pt-6 pb-24 px-6 relative overflow-hidden shadow-2xl">
    <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(white 1px, transparent 1px); background-size: 30px 30px;"></div>
    <div class="max-w-7xl mx-auto flex justify-between items-center relative z-10">
      <div class="flex items-center gap-4">
        <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm border border-white/20">
          <lucide-icon name="calculator" class="w-8 h-8 text-white"></lucide-icon>
        </div>
        <div>
          <h1 class="text-3xl font-bold tracking-tight text-white">SimplexVision</h1>
          <p class="text-indigo-200 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full" [ngClass]="backendStatus === 'online' ? 'bg-emerald-400 animate-pulse' : 'bg-red-500'"></span>
            M√©todo Gr√°fico Interactivo
          </p>
        </div>
      </div>
      
      <div class="flex gap-3">
        <button (click)="loadExample()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg backdrop-blur-sm border border-white/10 transition flex items-center gap-2 text-sm font-medium">
          <lucide-icon name="book-open" class="w-4 h-4"></lucide-icon> Cargar Caso Real
        </button>
        <button (click)="clearAll()" class="bg-rose-500/20 hover:bg-rose-500/40 text-white px-4 py-2 rounded-lg backdrop-blur-sm border border-white/10 transition flex items-center gap-2 text-sm font-medium" title="Limpiar todo">
          <lucide-icon name="eraser" class="w-4 h-4"></lucide-icon>
        </button>
        <div class="w-px h-8 bg-white/20 mx-2"></div>
        <button (click)="startStepMode()" *ngIf="solution?.status === 'Optimal' && !isStepMode" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2.5 rounded-lg shadow-lg transition flex items-center gap-2 text-sm font-bold active:scale-95 animate-in fade-in">
          <lucide-icon name="presentation" class="w-4 h-4"></lucide-icon> Explicar Soluci√≥n
        </button>
        <button (click)="downloadReport()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-lg shadow-lg shadow-emerald-900/20 transition flex items-center gap-2 text-sm font-bold active:scale-95">
          <lucide-icon name="file-spreadsheet" class="w-4 h-4"></lucide-icon> Reporte
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 -mt-16 relative z-20">
    
    <div *ngIf="isExampleActive" class="mb-8 bg-white rounded-2xl shadow-xl border-l-4 border-indigo-500 p-6 animate-in slide-in-from-top-4">
      <div class="flex items-start gap-4">
        <div class="bg-indigo-100 p-3 rounded-full text-indigo-600 mt-1">
          <lucide-icon name="lightbulb" class="w-6 h-6"></lucide-icon>
        </div>
        <div>
          <h2 class="text-xl font-bold text-slate-800 mb-2">{{ exampleContext.title }}</h2>
          <p class="text-slate-600 text-sm leading-relaxed mb-4">{{ exampleContext.story }}</p>
          <div class="flex flex-wrap gap-4 text-xs font-bold text-slate-500">
            <span class="bg-slate-100 px-3 py-1 rounded-full border border-slate-200">Objetivo: {{ exampleContext.objectiveName }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- PANEL IZQUIERDO -->
      <div class="lg:col-span-4 space-y-6">
        
        <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden transform transition hover:shadow-2xl">
          <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
            <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm uppercase tracking-wide">
              <lucide-icon name="trending-up" class="w-4 h-4 text-indigo-500"></lucide-icon> Funci√≥n Objetivo
            </h3>
            <div class="flex bg-slate-200 rounded-lg p-1">
              <button (click)="setMaximize(true)" [class]="maximize ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-1 text-xs font-bold rounded-md transition-all">MAX</button>
              <button (click)="setMaximize(false)" [class]="!maximize ? 'bg-white shadow text-rose-600' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-1 text-xs font-bold rounded-md transition-all">MIN</button>
            </div>
          </div>
          <div class="p-6 bg-white">
            <div class="flex items-center gap-3 text-xl font-mono">
              <span class="font-bold text-slate-400 italic">Z =</span>
              <div class="relative flex-1 group">
                <input [(ngModel)]="objective.x" (ngModelChange)="triggerSolve()" type="number" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl py-3 px-3 text-center focus:border-indigo-500 focus:ring-0 outline-none font-bold text-slate-700 transition-colors">
                <span class="absolute right-3 top-3.5 text-slate-400 text-xs font-bold pointer-events-none">
                  {{ isExampleActive ? '($)' : 'X‚ÇÅ' }}
                </span>
                <div *ngIf="isExampleActive" class="absolute -bottom-5 left-0 w-full text-center text-[10px] text-indigo-600 font-bold uppercase tracking-wider">{{ exampleContext.x1Name }}</div>
              </div>
              <span class="text-slate-300 font-bold">+</span>
              <div class="relative flex-1 group">
                <input [(ngModel)]="objective.y" (ngModelChange)="triggerSolve()" type="number" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl py-3 px-3 text-center focus:border-indigo-500 focus:ring-0 outline-none font-bold text-slate-700 transition-colors">
                <span class="absolute right-3 top-3.5 text-slate-400 text-xs font-bold pointer-events-none">
                  {{ isExampleActive ? '($)' : 'X‚ÇÇ' }}
                </span>
                <div *ngIf="isExampleActive" class="absolute -bottom-5 left-0 w-full text-center text-[10px] text-indigo-600 font-bold uppercase tracking-wider">{{ exampleContext.x2Name }}</div>
              </div>
            </div>
            <div *ngIf="isExampleActive" class="h-4"></div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden flex flex-col max-h-[500px]">
          <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center sticky top-0 z-10">
            <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm uppercase tracking-wide">
              <lucide-icon name="grip" class="w-4 h-4 text-emerald-500"></lucide-icon> Restricciones
            </h3>
            <button (click)="addConstraint()" class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg hover:bg-emerald-100 font-bold transition flex items-center gap-1 active:scale-95">
              <lucide-icon name="plus" class="w-3 h-3"></lucide-icon> Agregar
            </button>
          </div>
          
          <div class="p-4 space-y-2 overflow-y-auto custom-scrollbar flex-1">
            <!-- AGREGADO: trackBy: trackByIndex -->
            <div *ngFor="let c of constraints; let i = index; trackBy: trackByIndex" 
                 class="flex flex-col gap-1 bg-slate-50 p-3 rounded-xl border border-slate-100 group hover:border-emerald-200 hover:shadow-sm transition-all animate-in slide-in-from-left-2 duration-300"
                 [ngClass]="{'ring-2 ring-indigo-500 bg-indigo-50': isStepMode && (i + 1) === currentStep}">
              
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-slate-200 text-slate-500 group-hover:bg-emerald-100 group-hover:text-emerald-600 flex items-center justify-center text-xs font-bold transition-colors">{{i+1}}</div>
                <input [(ngModel)]="c.x" (ngModelChange)="triggerSolve()" type="number" class="w-14 bg-white border border-slate-200 rounded px-1 text-center text-sm focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none font-medium">
                <span class="text-[10px] text-slate-400 font-bold">{{ isExampleActive ? exampleContext.x1Name.substring(0,3) : 'X‚ÇÅ' }}</span>
                <span class="text-slate-300 font-bold text-lg">+</span>
                <input [(ngModel)]="c.y" (ngModelChange)="triggerSolve()" type="number" class="w-14 bg-white border border-slate-200 rounded px-1 text-center text-sm focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none font-medium">
                <span class="text-[10px] text-slate-400 font-bold">{{ isExampleActive ? exampleContext.x2Name.substring(0,3) : 'X‚ÇÇ' }}</span>
                <select [(ngModel)]="c.operator" (ngModelChange)="triggerSolve()" class="bg-slate-200 border-none rounded px-1 py-1 text-sm font-bold text-slate-700 cursor-pointer focus:ring-0 mx-1">
                  <option value="<=">‚â§</option><option value=">=">‚â•</option><option value="=">=</option>
                </select>
                <input [(ngModel)]="c.rhs" (ngModelChange)="triggerSolve()" type="number" class="flex-1 min-w-[3rem] bg-white border border-slate-200 rounded px-2 py-1 text-center text-sm focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none font-bold text-slate-700">
                <button (click)="removeConstraint(i)" class="text-slate-300 hover:text-rose-500 hover:bg-rose-50 p-2 rounded-lg transition-all opacity-0 group-hover:opacity-100 cursor-pointer" title="Eliminar restricci√≥n">
                  <lucide-icon name="trash-2" class="w-4 h-4"></lucide-icon>
                </button>
              </div>
              <div *ngIf="isExampleActive && exampleContext.constraintsDesc[i]" class="pl-8 text-[10px] text-slate-500 italic border-l-2 border-slate-200 ml-2 mt-1">
                {{ exampleContext.constraintsDesc[i] }}
              </div>
            </div>
            
            <div *ngIf="constraints.length === 0" class="text-center py-10 text-slate-400 flex flex-col items-center gap-2 border-2 border-dashed border-slate-200 rounded-xl">
              <lucide-icon name="grip" class="w-8 h-8 text-slate-200"></lucide-icon>
              <span class="text-sm">Sin restricciones activas</span>
            </div>
          </div>
          
          <div class="bg-slate-50 px-6 py-2 border-t border-slate-100 text-[10px] text-slate-400 flex items-center justify-center uppercase tracking-widest font-bold">
            X‚ÇÅ, X‚ÇÇ ‚â• 0
          </div>
        </div>

         <div *ngIf="solution?.status === 'Optimal'" class="bg-gradient-to-br from-indigo-600 to-violet-700 rounded-2xl p-6 shadow-xl text-white relative overflow-hidden animate-in zoom-in duration-500">
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
            <h3 class="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
              <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div> Soluci√≥n √ìptima
            </h3>
            <div class="flex items-baseline gap-2 mb-6">
              <span class="text-5xl font-bold tracking-tighter">{{ solution?.optimal_solution?.z_value | number:'1.0-2' }}</span>
              <span class="text-indigo-300 font-mono text-sm">Valor Z</span>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white/10 rounded-xl p-3 backdrop-blur-md border border-white/10">
                <span class="text-indigo-200 text-[10px] uppercase font-bold tracking-wider block mb-1">
                  {{ isExampleActive ? exampleContext.x1Name : 'Variable X‚ÇÅ' }}
                </span>
                <div class="font-mono text-2xl font-bold">{{ solution?.optimal_solution?.point?.x | number:'1.0-2' }}</div>
              </div>
              <div class="bg-white/10 rounded-xl p-3 backdrop-blur-md border border-white/10">
                <span class="text-indigo-200 text-[10px] uppercase font-bold tracking-wider block mb-1">
                  {{ isExampleActive ? exampleContext.x2Name : 'Variable X‚ÇÇ' }}
                </span>
                <div class="font-mono text-2xl font-bold">{{ solution?.optimal_solution?.point?.y | number:'1.0-2' }}</div>
              </div>
            </div>
         </div>

         <div *ngIf="solution && solution.status !== 'Optimal'" class="bg-rose-50 border border-rose-200 rounded-2xl p-6 text-rose-700 flex flex-col items-center text-center animate-in shake">
            <lucide-icon name="x-circle" class="w-8 h-8 mb-2 opacity-50"></lucide-icon>
            <div class="font-bold">Sin soluci√≥n √≥ptima</div>
            <div class="text-xs mt-1 opacity-80">El problema puede ser infactible o no acotado.</div>
         </div>

      </div>
      <div class="lg:col-span-8">
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden h-[650px] flex flex-col relative group">
          
          <div *ngIf="isStepMode" class="absolute top-0 left-0 right-0 z-30 p-6 bg-gradient-to-b from-slate-900/90 to-transparent pointer-events-none">
              <div class="bg-white rounded-xl shadow-2xl p-5 border border-indigo-100 flex items-start gap-4 pointer-events-auto animate-in slide-in-from-top-4">
                <div class="bg-indigo-600 text-white w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg shadow-md">
                  {{ currentStep }}
                </div>
                <div class="flex-1">
                  <h4 class="font-bold text-indigo-900 text-base mb-1">An√°lisis Paso a Paso</h4>
                  <p class="text-slate-800 text-sm font-medium mb-2">{{ stepDescription }}</p>
                  <div *ngIf="stepBusinessMeaning" class="bg-emerald-50 text-emerald-800 text-xs p-2 rounded-lg border border-emerald-100 italic">
                    üí° {{ stepBusinessMeaning }}
                  </div>
                </div>
                <div class="flex flex-col gap-2">
                   <div class="flex gap-1">
                     <button (click)="prevStep()" [disabled]="currentStep <= 1" class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200 disabled:opacity-50 transition">
                       <lucide-icon name="arrow-left" class="w-4 h-4"></lucide-icon>
                     </button>
                     <button (click)="nextStep()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-indigo-200 transition flex items-center gap-2">
                       {{ currentStep === totalSteps ? 'Finalizar' : 'Siguiente' }} <lucide-icon name="arrow-right" class="w-4 h-4"></lucide-icon>
                     </button>
                   </div>
                   <button (click)="exitStepMode()" class="text-slate-400 hover:text-rose-500 text-xs text-center hover:underline mt-1">
                     Salir del tutorial
                   </button>
                </div>
             </div>
          </div>

          <!-- LEYENDA -->
          <div class="absolute top-4 right-4 z-10 flex flex-col gap-2 opacity-90 hover:opacity-100 transition-opacity">
            <button (click)="resetCamera()" class="bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg shadow-sm border border-slate-200 flex items-center gap-2 text-xs font-bold text-slate-600 hover:bg-slate-50 cursor-pointer mb-2">
               <lucide-icon name="refresh-cw" class="w-3 h-3"></lucide-icon> Centrar Vista
            </button>
            <div class="bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg shadow-sm border border-emerald-200 flex items-center gap-2 text-xs font-bold text-emerald-700 pointer-events-none">
              <div class="w-4 h-4 bg-emerald-500/20 border border-emerald-500 rounded-sm"></div> Regi√≥n Factible
            </div>
            <div class="bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg shadow-sm border border-rose-200 flex items-center gap-2 text-xs font-bold text-rose-600 pointer-events-none">
               <div class="w-6 h-0 border-t-2 border-dashed border-rose-500"></div> Funci√≥n Objetivo
            </div>
          </div>

          <div class="absolute bottom-12 left-1/2 transform -translate-x-1/2 bg-black/50 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity z-10">
             Arrastra para mover ‚Ä¢ Rueda para Zoom
          </div>

          <!-- LIENZO SVG -->
          <div class="flex-1 bg-slate-50 relative cursor-grab active:cursor-grabbing overflow-hidden" #graphContainer
               (mousedown)="onMouseDown($event)"
               (mousemove)="onMouseMove($event)"
               (mouseup)="onMouseUp()"
               (mouseleave)="onMouseUp()"
               (wheel)="onWheel($event)">
            
            <svg *ngIf="viewBox" [attr.viewBox]="viewBox" class="w-full h-full transform scale-y-[-1] origin-center select-none" preserveAspectRatio="xMidYMid meet">
              <defs>
                <pattern id="smallGrid" [attr.width]="gridSize" [attr.height]="gridSize" patternUnits="userSpaceOnUse">
                  <path [attr.d]="'M ' + gridSize + ' 0 L 0 0 0 ' + gridSize" fill="none" stroke="#e2e8f0" [attr.stroke-width]="gridSize * 0.05"/>
                </pattern>
              </defs>
              <rect x="-1000" y="-1000" width="2000" height="2000" fill="#f8fafc" />
              <rect x="-1000" y="-1000" width="2000" height="2000" fill="url(#smallGrid)" />
              <line x1="-1000" y1="0" x2="1000" y2="0" stroke="#94a3b8" [attr.stroke-width]="gridSize * 0.1" />
              <line x1="0" y1="-1000" x2="0" y2="1000" stroke="#94a3b8" [attr.stroke-width]="gridSize * 0.1" />

              <g [attr.font-size]="gridSize * 0.3 + 'px'" font-family="monospace" fill="#64748b" text-anchor="middle">
                <g *ngFor="let x of xTicks">
                  <line [attr.x1]="x" [attr.y1]="-gridSize*0.1" [attr.x2]="x" [attr.y2]="gridSize*0.1" stroke="#cbd5e1" [attr.stroke-width]="gridSize*0.05"/>
                  <text [attr.x]="x" [attr.y]="-gridSize*0.3" transform="scale(1, -1)" class="select-none font-bold">{{x | number:'1.0-1'}}</text>
                </g>
                <g *ngFor="let y of yTicks">
                  <line [attr.x1]="-gridSize*0.1" [attr.y1]="y" [attr.x2]="gridSize*0.1" [attr.y2]="y" stroke="#cbd5e1" [attr.stroke-width]="gridSize*0.05"/>
                  <text [attr.x]="-gridSize*0.4" [attr.y]="-y" transform="scale(1, -1)" class="select-none font-bold" dominant-baseline="middle">{{y | number:'1.0-1'}}</text>
                </g>
              </g>

              <g *ngFor="let line of renderLines; let i = index">
                <line *ngIf="shouldShowConstraint(i)" 
                      [attr.x1]="line.x1" [attr.y1]="line.y1" [attr.x2]="line.x2" [attr.y2]="line.y2" 
                      stroke="#64748b" [attr.stroke-width]="gridSize * 0.08" stroke-dasharray="0.3, 0.2" opacity="0.8" 
                      class="animate-in fade-in duration-700"/>
              </g>

              <polygon *ngIf="(solution?.feasible_region?.length || 0) > 2 && shouldShowFeasible()" 
                       [attr.points]="getPolygonPoints()" 
                       fill="#10b981" 
                       fill-opacity="0.25" 
                       stroke="#059669" 
                       [attr.stroke-width]="gridSize * 0.1"
                       class="transition-all duration-700 ease-in-out animate-in zoom-in fade-in"/>

              <line *ngIf="solution?.optimal_solution?.point && shouldShowObjective()"
                    [attr.x1]="objLine.x1" [attr.y1]="objLine.y1" 
                    [attr.x2]="objLine.x2" [attr.y2]="objLine.y2"
                    stroke="#e11d48" 
                    [attr.stroke-width]="gridSize * 0.15" 
                    stroke-dasharray="0.5, 0.2"
                    class="transition-all duration-1000 ease-out opacity-80 animate-in slide-in-from-left-10" />
              
              <!-- ETIQUETA OPTIMIZADA -->
              <g *ngIf="solution?.optimal_solution?.point && shouldShowOptimal()" class="animate-in zoom-in duration-500">
                <circle [attr.cx]="solution?.optimal_solution?.point?.x" 
                        [attr.cy]="solution?.optimal_solution?.point?.y" 
                        [attr.r]="gridSize * 0.5" fill="#e11d48" class="animate-ping" opacity="0.3"/>
                <circle [attr.cx]="solution?.optimal_solution?.point?.x" 
                        [attr.cy]="solution?.optimal_solution?.point?.y" 
                        [attr.r]="gridSize * 0.15" fill="#e11d48" stroke="white" [attr.stroke-width]="gridSize * 0.05"/>
                
                <g [attr.transform]="'translate(' + solution?.optimal_solution?.point?.x + ',' + solution?.optimal_solution?.point?.y + ') scale(1, -1)'">
                   <rect [attr.x]="gridSize * 0.3" [attr.y]="-gridSize * 0.5" 
                         [attr.width]="gridSize * 3.5" [attr.height]="gridSize * 0.6" 
                         rx="0.1" ry="0.1" fill="#312e81" opacity="0.9"/>
                   <text [attr.x]="gridSize * 0.5" [attr.y]="-gridSize * 0.2" 
                         [attr.font-size]="gridSize * 0.25" fill="white" font-family="monospace" font-weight="bold" dominant-baseline="middle">
                      X‚ÇÅ:{{ solution?.optimal_solution?.point?.x | number:'1.0-1' }} X‚ÇÇ:{{ solution?.optimal_solution?.point?.y | number:'1.0-1' }}
                   </text>
                </g>
              </g>

            </svg>

            <div *ngIf="loading" class="absolute inset-0 bg-white/60 backdrop-blur-[2px] flex flex-col items-center justify-center z-50 transition-opacity duration-300">
               <lucide-icon name="refresh-cw" class="w-10 h-10 text-indigo-600 animate-spin mb-3"></lucide-icon>
               <span class="text-indigo-900 font-bold text-sm tracking-wide">OPTIMIZANDO...</span>
            </div>

            <div *ngIf="!loading && !solution" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
               <lucide-icon name="grip" class="w-12 h-12 mb-2 opacity-50"></lucide-icon>
               <p class="text-sm font-medium">Configura las restricciones para comenzar</p>
            </div>
          </div>
          
          <div class="bg-white px-4 py-2 border-t border-slate-200 flex justify-between text-[10px] font-mono text-slate-400 uppercase tracking-wider">
            <div>Vista: [{{ camX | number:'1.0-0' }}, {{ camY | number:'1.0-0' }}]</div>
            <div class="flex gap-4">
              <span>Zoom: {{ 12 / camWidth | percent }}</span>
              <span *ngIf="solution?.status === 'Optimal'" class="text-emerald-600 font-bold">Estado: √ìptimo Global</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>